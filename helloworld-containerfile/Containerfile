FROM registry.access.redhat.com/ubi8/python-312

WORKDIR /opt/app-root/

USER root

# Install system dependencies
RUN dnf -y update && \
    dnf install -y gcc gcc-c++ && \
    dnf clean all

# Install UV using pip and ensure it's in PATH
RUN pip3 install --upgrade pip && \
    pip3 install uv && \
    ln -sf $(python3 -m site --user-base)/bin/uv /usr/local/bin/uv || \
    ln -sf /usr/local/bin/uv /usr/bin/uv || true

# Verify UV is available
RUN uv --version

# Copy application files
COPY . /opt/app-root

# Set environment variables
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_CACHE_DIR=/opt/app-root/.cache/uv \
    PATH="/opt/app-root/.venv/bin:${PATH}"

# Create necessary directories
RUN mkdir -p /opt/app-root/.cache/uv

# Install dependencies
RUN uv sync --frozen --no-install-project --no-dev && \
    uv sync --frozen --no-dev

# Set permissions
RUN chgrp -R root /opt/app-root/ && \
    chmod -R g+rwx /opt/app-root/

EXPOSE 9999

USER 1001

CMD ["uv", "run", ".", "--host", "0.0.0.0"]
