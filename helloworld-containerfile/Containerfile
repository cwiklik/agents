FROM registry.access.redhat.com/ubi8/python-312

WORKDIR /opt/app-root

USER root

# Install build dependencies
RUN dnf -y update && \
    dnf install -y gcc gcc-c++ && \
    dnf clean all

# Install UV from official image
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy project files
COPY . /opt/app-root/

# Install dependencies using UV but let it use system python
RUN /usr/local/bin/uv pip install --system -r pyproject.toml

# OR if you have requirements.txt
# RUN /usr/local/bin/uv pip install --system -r requirements.txt

# Set OpenShift-compatible permissions
RUN chgrp -R 0 /opt/app-root && \
    chmod -R g+rwX /opt/app-root

ENV PYTHONUNBUFFERED=1

EXPOSE 9999

USER 1001

# Use system python3
CMD ["python3", "__main__.py"]
